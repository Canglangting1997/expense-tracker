<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Expense Tracker</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding-bottom: 80px; }
        
        .header { background: linear-gradient(135deg, #007AFF 0%, #0056CC 100%); color: white; padding: 20px; text-align: center; position: relative; }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .sync-status { position: absolute; top: 20px; right: 20px; font-size: 12px; }
        
        .tabs { display: flex; background: white; border-bottom: 1px solid #eee; position: sticky; top: 0; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { border-bottom-color: #007AFF; color: #007AFF; font-weight: bold; }
        
        .page { display: none; padding: 20px; }
        .page.active { display: block; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #666; font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        
        .btn { width: 100%; padding: 14px; background: #007AFF; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn:active { opacity: 0.8; }
        .btn-secondary { background: #8E8E93; margin-top: 10px; }
        .btn-green { background: #34C759; }
        
        .record { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .record-info { flex: 1; }
        .record-date { font-size: 12px; color: #999; }
        .record-category { font-weight: bold; margin: 3px 0; }
        .record-note { font-size: 12px; color: #666; }
        .record-amount { font-size: 18px; font-weight: bold; }
        
        .delete-btn { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; margin-left: 10px; font-size: 12px; }
        
        .summary { background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; }
        .summary h3 { margin-bottom: 15px; color: #333; }
        .summary-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .summary-total { font-weight: 600; font-size: 18px; color: #007AFF; }
        
        .month-select { display: flex; gap: 10px; margin-bottom: 15px; }
        .month-select select { flex: 1; }
        
        .export-btns { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .export-btns .btn { flex: 1; min-width: 120px; }
        
        .detail-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; }
        .detail-modal.active { display: flex; align-items: center; justify-content: center; }
        .detail-content { background: white; width: 90%; max-width: 400px; max-height: 80vh; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; }
        .detail-header { background: #007AFF; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .detail-header h3 { font-size: 16px; }
        .detail-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .detail-body { padding: 15px; overflow-y: auto; flex: 1; }
        .detail-item { padding: 12px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .detail-date { font-size: 12px; color: #999; }
        .detail-note { font-size: 12px; color: #666; margin-top: 2px; }
        .clickable { cursor: pointer; background: #f8f8f8; border-radius: 8px; padding: 12px; margin-bottom: 8px; }
        
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 8px; font-size: 14px; z-index: 2000; opacity: 0; transition: opacity 0.3s; }
        .toast.show { opacity: 1; }
        
        .token-input { font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ’° Expense Tracker</h1>
        <div class="sync-status" id="syncStatus">â˜ï¸</div>
    </div>
    
    <div class="tabs">
        <div class="tab active" onclick="showPage('add')">Add</div>
        <div class="tab" onclick="showPage('records')">Records</div>
        <div class="tab" onclick="showPage('report')">Report</div>
        <div class="tab" onclick="showPage('settings')">âš™ï¸</div>
    </div>
    
    <div id="add" class="page active">
        <div class="form-group">
            <label>Date</label>
            <input type="date" id="date">
        </div>
        <div class="form-group">
            <label>Amount</label>
            <input type="number" id="amount" placeholder="0.00" step="0.01">
        </div>
        <div class="form-group">
            <label>Country</label>
            <div style="display:flex;gap:8px;">
                <select id="currency">
                    <option value="USA">ğŸ‡ºğŸ‡¸ ç¾å›½ (USD)</option>
                    <option value="Canada">ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§ (CAD)</option>
                    <option value="China">ğŸ‡¨ğŸ‡³ ä¸­å›½ (CNY)</option>
                    <option value="Europe">ğŸ‡ªğŸ‡º æ¬§æ´² (EUR)</option>
                </select>
                <button type="button" onclick="detectLocationAndSetCurrency()" style="padding:12px;background:#34C759;color:white;border:none;border-radius:8px;font-size:14px;">ğŸ“</button>
            </div>
        </div>
        <div class="form-group">
            <label>åˆ†ç±»</label>
            <select id="category">
                <option value="grocery">ğŸ›’ Grocery</option>
                <option value="car">ğŸš— Car</option>
                <option value="food">ğŸ” Food</option>
                <option value="family">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Family</option>
                <option value="others">ğŸ“¦ Others</option>
            </select>
        </div>
        <div class="form-group">
            <label>Note (optional)</label>
            <input type="text" id="note" placeholder="Note">
        </div>
        <div class="form-group">
            <label>Address (optional)</label>
            <div style="display: flex; gap: 8px;">
                <input type="text" id="address" placeholder="Address">
                <button type="button" onclick="getLocation()" style="padding: 12px; background: #007AFF; color: white; border: none; border-radius: 8px; font-size: 14px;">ğŸ“</button>
            </div>
        </div>
        <button class="btn" onclick="addRecord()">Save</button>
    </div>
    
    <div id="records" class="page">
        <div id="recordsList"></div>
    </div>
    
    <div id="report" class="page">
        <div class="month-select">
            <select id="reportMonth" onchange="generateReport()"></select>
            <select id="reportYear" onchange="generateReport()"></select>
        </div>
        <div id="reportContent"></div>
        <button class="btn" style="margin-top:15px;background:#34C759;" onclick="showMonthlySummary()">ğŸ“… Monthly Summary</button>
        <div class="export-btns">
            <button class="btn" onclick="exportData()">Export CSV</button>
            <button class="btn" onclick="importData()" style="background:#FF9500;">Import CSV</button>
            <button class="btn btn-secondary" onclick="clearData()">Clear All</button>
        </div>
    </div>
    
    <div id="settings" class="page">
        <div class="summary">
            <h3>â˜ï¸ äº‘åŒæ­¥è®¾ç½®</h3>
            <div class="form-group">
                <label>GitHub Token</label>
                <input type="password" id="githubToken" class="token-input" placeholder="ghp_xxxxxx">
                <small style="color:#666;font-size:12px;">åœ¨ GitHub â†’ Settings â†’ Developer settings â†’ Personal access tokens ç”Ÿæˆï¼Œéœ€å‹¾é€‰ gist æƒé™</small>
            </div>
            <button class="btn btn-green" onclick="saveToken()">ä¿å­˜ Token</button>
            <button class="btn" style="margin-top:10px;" onclick="syncToCloud()">â˜ï¸ ç«‹å³åŒæ­¥</button>
        </div>
    </div>

    <div id="detailModal" class="detail-modal">
        <div class="detail-content">
            <div class="detail-header">
                <h3 id="detailTitle">Details</h3>
                <button class="detail-close" onclick="closeDetail()">Ã—</button>
            </div>
            <div id="detailBody" class="detail-body"></div>
        </div>
    </div>
    
    <div id="toast" class="toast"></div>

    <script>
        const GIST_ID = '759628f4aab5459756d1fb3f2ce7c75b';
        const GIST_FILENAME = 'expense-data.json';
        
        document.getElementById('date').valueAsDate = new Date();
        
        function getToken() { return localStorage.getItem('githubToken') || ''; }
        
        function saveToken() {
            const token = document.getElementById('githubToken').value.trim();
            if (token) {
                localStorage.setItem('githubToken', token);
                showToast('Token å·²ä¿å­˜');
                syncToCloud();
            } else {
                showToast('è¯·è¾“å…¥ Token');
            }
        }
        
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function updateSyncStatus(status) { document.getElementById('syncStatus').textContent = status; }
        
        async function loadFromCloud() {
            const token = getToken();
            if (!token) return null;
            try {
                const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
                });
                if (response.ok) {
                    const data = await response.json();
                    const content = data.files[GIST_FILENAME]?.content;
                    if (content) return JSON.parse(content);
                }
            } catch (e) { console.log('Load error:', e); }
            return null;
        }
        
        async function saveToCloud(records) {
            const token = getToken();
            if (!token) return false;
            try {
                const content = JSON.stringify(records, null, 2);
                const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ files: { [GIST_FILENAME]: { content } } })
                });
                return response.ok;
            } catch (e) { console.log('Save error:', e); }
            return false;
        }
        
        async function syncToCloud() {
            const token = getToken();
            if (!token) { showToast('è¯·å…ˆè®¾ç½® GitHub Token'); return; }
            updateSyncStatus('ğŸ”„');
            const success = await saveToCloud(getRecords());
            updateSyncStatus(success ? 'âœ…' : 'âŒ');
            showToast(success ? 'å·²åŒæ­¥åˆ°äº‘ç«¯' : 'åŒæ­¥å¤±è´¥');
        }
        
        async function initApp() {
            const cloudData = await loadFromCloud();
            if (cloudData && cloudData.length > 0 && getRecords().length === 0) {
                saveRecords(cloudData);
                showToast('å·²ä»äº‘ç«¯åŠ è½½æ•°æ®');
            }
            updateSyncStatus(getToken() ? 'â˜ï¸' : 'ğŸ“±');
        }
        
        function detectLocationAndSetCurrency() {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition((position) => {
                const lon = position.coords.longitude;
                const lat = position.coords.latitude;
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`)
                    .then(r => r.json()).then(data => {
                        let currency = 'Canada';
                        if (data.address) {
                            const c = data.address.country_code?.toUpperCase();
                            if (c === 'CA') currency = 'Canada';
                            else if (c === 'US') currency = 'USA';
                            else if (c === 'CN') currency = 'China';
                            else if (c && ['DE','FR','IT','ES','NL','BE','AT','PT','GR'].includes(c)) currency = 'Europe';
                        }
                        document.getElementById('currency').value = currency;
                    });
            });
        }
        
        detectLocationAndSetCurrency();
        initApp();
        
        const now = new Date();
        const monthSelect = document.getElementById('reportMonth');
        const yearSelect = document.getElementById('reportYear');
        
        for (let i = 0; i < 12; i++) {
            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const o = document.createElement('option');
            o.value = d.getMonth();
            o.text = (d.getMonth() + 1) + 'æœˆ';
            if (i === 0) o.selected = true;
            monthSelect.appendChild(o);
        }
        for (let y = now.getFullYear(); y >= now.getFullYear() - 2; y--) {
            const o = document.createElement('option');
            o.value = y;
            o.text = y + 'å¹´';
            if (y === now.getFullYear()) o.selected = true;
            yearSelect.appendChild(o);
        }
        
        function getRecords() { return JSON.parse(localStorage.getItem('expenseRecords') || '[]'); }
        function saveRecords(records) { localStorage.setItem('expenseRecords', JSON.stringify(records)); }
        
        async function addRecord() {
            const date = document.getElementById('date').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const currency = document.getElementById('currency').value;
            const category = document.getElementById('category').value;
            const note = document.getElementById('note').value;
            const address = document.getElementById('address').value;
            
            if (!date || !amount) { alert('Please fill in date and amount'); return; }
            
            const records = getRecords();
            records.push({ date, amount, currency, category, note, address, id: Date.now() });
            saveRecords(records);
            await saveToCloud(records);
            
            document.getElementById('amount').value = '';
            document.getElementById('note').value = '';
            document.getElementById('address').value = '';
            document.getElementById('date').valueAsDate = new Date();
            showToast('å·²ä¿å­˜');
            showPage('records');
        }
        
        function getLocation() {
            if (!navigator.geolocation) { alert('Location not supported'); return; }
            navigator.geolocation.getCurrentPosition((position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`)
                    .then(r => r.json()).then(data => {
                        let addr = data.address?.road || data.address?.city || data.address?.town || data.display_name?.split(',').slice(0,2).join(',') || '';
                        document.getElementById('address').value = addr;
                    });
            });
        }
        
        const icons = { 'grocery': 'ğŸ›’', 'car': 'ğŸš—', 'food': 'ğŸ”', 'family': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§', 'others': 'ğŸ“¦' };
        const symbols = { 'USA': '$', 'Canada': 'C$', 'China': 'Â¥', 'Europe': 'â‚¬' };
        const flags = { 'USA': 'ğŸ‡ºğŸ‡¸', 'Canada': 'ğŸ‡¨ğŸ‡¦', 'China': 'ğŸ‡¨ğŸ‡³', 'Europe': 'ğŸ‡ªğŸ‡º' };
        
        function showRecords() {
            const records = getRecords().sort((a, b) => new Date(b.date) - new Date(a.date));
            const c = document.getElementById('recordsList');
            if (records.length === 0) { c.innerHTML = '<div class="empty">No records</div>'; return; }
            c.innerHTML = records.map(r => `
                <div class="record">
                    <div class="record-info">
                        <div class="record-date">${r.date} Â· ${flags[r.currency]} ${r.address ? ' ğŸ“ ' + r.address : ''}</div>
                        <div class="record-category">${icons[r.category]} ${r.category}</div>
                        <div class="record-note">${r.note || ''}</div>
                    </div>
                    <div class="record-amount">${symbols[r.currency]}${r.amount.toFixed(2)}</div>
                    <button class="delete-btn" onclick="deleteRecord(${r.id})">Delete</button>
                </div>
            `).join('');
        }
        
        async function deleteRecord(id) {
            if (!confirm('Delete this record?')) return;
            const records = getRecords().filter(r => r.id !== id);
            saveRecords(records);
            await saveToCloud(records);
            showRecords();
        }
        
        function generateReport() {
            const month = parseInt(document.getElementById('reportMonth').value);
            const year = parseInt(document.getElementById('reportYear').value);
            const records = getRecords().filter(r => { const d = new Date(r.date); return d.getMonth() === month && d.getFullYear() === year; });
            
            if (records.length === 0) { document.getElementById('reportContent').innerHTML = '<div class="empty">No records</div>'; return; }
            
            const byCountry = {}, byCategory = {};
            const rates = { 'USA': 1.35, 'Canada': 1, 'China': 0.19, 'Europe': 1.45 };
            let cad = 0, usd = 0, cny = 0, eur = 0, total = 0;
            
            records.forEach(r => {
                const rate = rates[r.currency] || 1;
                const cadAmount = r.amount * rate;
                byCountry[r.currency] = (byCountry[r.currency] || 0) + r.amount;
                byCategory[r.category] = (byCategory[r.category] || 0) + cadAmount;
                if (r.currency === 'Canada') cad += r.amount;
                else if (r.currency === 'USA') usd += r.amount;
                else if (r.currency === 'China') cny += r.amount;
                else if (r.currency === 'Europe') eur += r.amount;
                total += cadAmount;
            });
            
            let html = '<div class="summary" style="background:#fff3cd;"><h3>ğŸ“… æœ¬æœˆæ±‡æ€»</h3>';
            for (const [cat, amount] of Object.entries(byCategory)) html += `<div class="summary-row"><span>${icons[cat]} ${cat}</span><span>C$${amount.toFixed(2)}</span></div>`;
            if (cad > 0) html += `<div class="summary-row"><span>ğŸ‡¨ğŸ‡¦ CAD</span><span>C$${cad.toFixed(2)}</span></div>`;
            if (usd > 0) html += `<div class="summary-row"><span>ğŸ‡ºğŸ‡¸ USD</span><span>$${usd.toFixed(2)}</span></div>`;
            if (cny > 0) html += `<div class="summary-row"><span>ğŸ‡¨ğŸ‡³ CNY</span><span>Â¥${cny.toFixed(2)}</span></div>`;
            if (eur > 0) html += `<div class="summary-row"><span>ğŸ‡ªğŸ‡º EUR</span><span>â‚¬${eur.toFixed(2)}</span></div>`;
            html += `<div class="summary-row"><span>ğŸ’° æ€»è®¡ (CAD)</span><span class="summary-total">C$${total.toFixed(2)}</span></div></div>`;
            
            html += '<div class="summary"><h3>ğŸ“Š By Country</h3>';
            for (const [c, a] of Object.entries(byCountry)) html += `<div class="clickable" onclick="showCountryDetail('${c}')"><div class="summary-row"><span>${flags[c]} ${c}</span><span>${symbols[c]}${a.toFixed(2)}</span></div></div>`;
            html += '</div>';
            
            html += '<div class="summary"><h3>ğŸ“ By Category</h3>';
            for (const [cat, a] of Object.entries(byCategory)) html += `<div class="clickable" onclick="showCategoryDetail('${cat}')"><div class="summary-row"><span>${icons[cat]} ${cat}</span><span>C$${a.toFixed(2)}</span></div></div>`;
            html += '</div>';
            
            document.getElementById('reportContent').innerHTML = html;
        }
        
        function showMonthlySummary() {
            const records = getRecords();
            if (records.length === 0) { document.getElementById('reportContent').innerHTML = '<div class="empty">No records</div>'; return; }
            const rates = { 'USA': 1.35, 'Canada': 1, 'China': 0.19, 'Europe': 1.45 };
            const data = {};
            records.forEach(r => {
                const d = new Date(r.date);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                if (!data[key]) data[key] = { name: `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ`, total: 0, count: 0 };
                data[key].total += r.amount * (rates[r.currency] || 1);
                data[key].count++;
            });
            const keys = Object.keys(data).sort((a,b) => b.localeCompare(a));
            let html = '<div class="summary"><h3>ğŸ“… Monthly Summary</h3>';
            let grand = 0;
            for (const k of keys) { grand += data[k].total; html += `<div class="clickable"><div class="summary-row"><span>${data[k].name} (${data[k].count}ç¬”)</span><span>C$${data[k].total.toFixed(2)}</span></div></div>`; }
            html += `<div class="summary"><div class="summary-row"><span>Grand Total</span><span class="summary-total">C$${grand.toFixed(2)}</span></div></div>`;
            document.getElementById('reportContent').innerHTML = html;
        }
        
        function showMonthDetail(key) {
            const [year, month] = key.split('-').map(Number);
            const records = getRecords().filter(r => { const d = new Date(r.date); return d.getMonth() === month - 1 && d.getFullYear() === year; }).sort((a,b) => new Date(b.date) - new Date(a.date));
            if (!records.length) { alert('No records'); return; }
            let html = records.map(r => `<div class="detail-item"><div><div class="detail-date">${r.date} Â· ${flags[r.currency]} ${icons[r.category]} ${r.category}</div><div class="detail-note">${r.note || r.address || ''}</div></div><div style="font-weight:bold;">${symbols[r.currency]}${r.amount.toFixed(2)}</div></div>`).join('');
            document.getElementById('detailTitle').textContent = 'ğŸ“… ' + key;
            document.getElementById('detailBody').innerHTML = html;
            document.getElementById('detailModal').classList.add('active');
        }
        
        function showCountryDetail(country) {
            const month = parseInt(document.getElementById('reportMonth').value);
            const year = parseInt(document.getElementById('reportYear').value);
            const records = getRecords().filter(r => { const d = new Date(r.date); return d.getMonth() === month && d.getFullYear() === year && r.currency === country; }).sort((a,b) => new Date(b.date) - new Date(a.date));
            if (!records.length) { alert('No records'); return; }
            let html = records.map(r => `<div class="detail-item"><div><div class="detail-date">${r.date} Â· ${icons[r.category]} ${r.category}</div><div class="detail-note">${r.note || r.address || ''}</div></div><div style="font-weight:bold;">${symbols[country]}${r.amount.toFixed(2)}</div></div>`).join('');
            document.getElementById('detailTitle').textContent = 'ğŸ“Š ' + flags[country] + ' ' + country;
            document.getElementById('detailBody').innerHTML = html;
            document.getElementById('detailModal').classList.add('active');
        }
        
        function showCategoryDetail(category) {
            const month = parseInt(document.getElementById('reportMonth').value);
            const year = parseInt(document.getElementById('reportYear').value);
            const records = getRecords().filter(r => { const d = new Date(r.date); return d.getMonth() === month && d.getFullYear() === year && r.category === category; }).sort((a,b) => new Date(b.date) - new Date(a.date));
            if (!records.length) { alert('No records'); return; }
            let html = records.map(r => `<div class="detail-item"><div><div class="detail-date">${r.date} Â· ${flags[r.currency]} ${r.currency}</div><div class="detail-note">${r.note || r.address || ''}</div></div><div style="font-weight:bold;">${symbols[r.currency]}${r.amount.toFixed(2)}</div></div>`).join('');
            document.getElementById('detailTitle').textContent = 'ğŸ“ ' + icons[category] + ' ' + category;
            document.getElementById('detailBody').innerHTML = html;
            document.getElementById('detailModal').classList.add('active');
        }
        
        function closeDetail() { document.getElementById('detailModal').classList.remove('active'); }
        document.getElementById('detailModal').addEventListener('click', function(e) { if (e.target === this) closeDetail(); });
        
        function exportData() {
            const records = getRecords();
            if (!records.length) { alert('No data'); return; }
            let csv = 'æ—¥æœŸ,é‡‘é¢,è´§å¸,åˆ†ç±»,å¤‡æ³¨\n';
            records.forEach(r => csv += `${r.date},${r.amount},${r.currency},${r.category},${r.note || ''}\n`);
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `expenses_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
        
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(event) {
                    const lines = event.target.result.split('\n');
                    let imported = 0;
                    lines.forEach((line, i) => {
                        if (i === 0) return;
                        const parts = line.split(',');
                        if (parts.length >= 4) {
                            const record = { date: parts[0].trim(), amount: parseFloat(parts[1]) || 0, currency: parts[2].trim(), category: parts[3].trim(), note: parts[4] ? parts[4].trim() : '', id: Date.now() + i };
                            if (record.date && record.amount > 0) { const records = getRecords(); records.push(record); saveRecords(records); imported++; }
                        }
                    });
                    alert(`å¯¼å…¥ ${imported} æ¡è®°å½•ï¼`);
                    showRecords();
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function clearData() {
            if (!confirm('Clear ALL data?')) return;
            localStorage.removeItem('expenseRecords');
            alert('å·²æ¸…ç©º');
            showRecords();
        }
        
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.tab')[pageId === 'add' ? 0 : pageId === 'records' ? 1 : pageId === 'report' ? 2 : 3].classList.add('active');
            if (pageId === 'records') showRecords();
            if (pageId === 'report') generateReport();
        }
    </script>
</body>
</html>
